<header class="modern-navbar">
  <div class="navbar-container">

    <!-- Left Section: Logo/Brand -->
    <div class="navbar-left">
      <button *ngIf="shouldShowToggle" class="sidebar-toggle-btn" (click)="toggleSidebar()">
        <mat-icon>{{ sidebarOpen ? 'menu_open' : 'menu' }}</mat-icon>
      </button>

      <div class="logo-container" (click)="navigateToDashboard()">
        <img src="../../../assets/images/Vector.svg" alt="Legal Assistance System Logo" class="header-logo" />
        <span class="app-title">{{label.COMMON.LEGAL_ASSISTANCE_SYSTEM}}</span>
      </div>
    </div>

    <!-- Center Section: Search -->
    <div class="navbar-center">
      <div class="search-container">
        <div class="search-input-wrapper">
          <mat-icon class="search-icon">search</mat-icon>

          <input type="text" class="search-input" [(ngModel)]="params.search" [ngModelOptions]="{standalone: true}"
            [placeholder]="label.COMMON.MASTER_SEARCH_PLACEHLDER || 'Search persons, companies, real estates...'"
            (keyup.enter)="onSearch(); menuTrigger.openMenu()" #searchInput />

          <!-- Search Button / Spinner -->
          <button class="search-button"
                  (click)="onSearch(); menuTrigger.openMenu()"
                  [matMenuTriggerFor]="searchMenu"
                  #menuTrigger="matMenuTrigger"
                  *ngIf="params.search"
                  [disabled]="isSearching"
                  [matMenuTriggerRestoreFocus]="false">
            <ng-container *ngIf="!isSearching; else loadingSpinner">
              <mat-icon>arrow_forward</mat-icon>
            </ng-container>
            <ng-template #loadingSpinner>
              <mat-progress-spinner diameter="20" mode="indeterminate" color="primary"></mat-progress-spinner>
            </ng-template>
          </button>
        </div>

        <!-- Quick Create Button -->
        <button class="create-button" [matMenuTriggerFor]="listToCreate_menu">
          <mat-icon>add</mat-icon>
          <span>{{ label.COMMON.CREATE }}</span>
        </button>
      </div>
    </div>

    <!-- Right Section: User Controls -->
    <div class="navbar-right">
      <div class="control-item">
        <button class="control-button user-profile" [matMenuTriggerFor]="profile">
          <div class="avatar-container">
            <mat-icon>account_circle</mat-icon>
          </div>
          <div class="user-info">
            <span class="username">{{user?.userName}}</span>
            <mat-icon class="dropdown-icon">expand_more</mat-icon>
          </div>
        </button>
      </div>
    </div>

  </div>
</header>

<!-- Create Menu -->
<mat-menu #listToCreate_menu="matMenu" class="create-menu">
  <button mat-menu-item *ngFor="let item of listToCreated" (click)="openAddDialog(item)">
    <mat-icon>{{item.icon}}</mat-icon>
    <span>{{ item.name }}</span>
  </button>
</mat-menu>

<!-- Language Menu -->
<mat-menu #languages_menu="matMenu">
  <button mat-menu-item *ngFor="let language of languages" (click)="selectDirection(language)">
    <mat-icon>language</mat-icon>
    <span>{{ language.name }}</span>
  </button>
</mat-menu>

<!-- Profile Menu -->
<mat-menu #profile="matMenu" class="profile-menu">
  <div class="profile-header">
    <mat-icon class="profile-avatar">account_circle</mat-icon>
    <div class="profile-details">
      <span class="profile-name">{{user?.userName}}</span>
      <span class="profile-email">{{user?.email || 'user@las.com'}}</span>
    </div>
  </div>

  <mat-divider></mat-divider>
  <button mat-menu-item [matMenuTriggerFor]="languages_menu">
    <mat-icon>language</mat-icon>
    <span>Language: {{selectedLanguage.name}}</span>
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="logout()" class="logout-item">
    <mat-icon>logout</mat-icon>
    <span>Sign Out</span>
  </button>
</mat-menu>

<!-- Search Results Menu -->
<mat-menu #searchMenu="matMenu" class="search-menu">
  <div class="search-results" style="max-height: 300px; overflow-y: auto;" (click)="$event.stopPropagation()">
    <ng-container *ngIf="searchResults.length; else noResults">

      <!-- List of results -->
      <button mat-menu-item *ngFor="let result of searchResults"
              class="search-result-item"
              (click)="openEntity(result); $event.stopPropagation()">
        <mat-icon>search</mat-icon>
        <div class="result-content">
          <span class="result-code">{{ result.entityCode }}</span>
          <small class="result-type">{{ result.entityType }}</small>
        </div>
      </button>

      <!-- Load more button -->
      <div class="load-more-container" *ngIf="hasMoreResults && !isLoadingMore">
        <button mat-button color="primary"
                (click)="loadMore($event); $event.stopPropagation()"
                matMenuItem
                [disableRipple]="true">
          {{ label.COMMON.LOAD_MORE || 'Load More' }}
        </button>
      </div>

      <!-- Loading spinner for load more -->
      <div class="load-more-container" *ngIf="isLoadingMore">
        <mat-progress-spinner diameter="24" mode="indeterminate" color="primary"></mat-progress-spinner>
      </div>

    </ng-container>

    <!-- No Results -->
    <ng-template #noResults>
      <div class="no-results">
        <mat-icon>search_off</mat-icon>
        <span>{{ label.COMMON.NO_RESULTS_FOUND }}</span>
      </div>
    </ng-template>
  </div>
</mat-menu>

<!-- Show spinner overlay when navigating -->
<div *ngIf="isNavigating" class="navigation-spinner-overlay">
  <mat-progress-spinner mode="indeterminate" diameter="48" color="primary"></mat-progress-spinner>
</div>
