<!-- Page Header -->
<mat-toolbar color="primary" class="page-header">
  <span class="page-title">Persons</span>
  <span class="flex-spacer"></span>
  <span class="records-count">{{ data.totalRecords || 0 }} Records</span>
  <button *ngIf="currentMenu?.canInsert" mat-raised-button color="accent" (click)="openAddDialog()">
    <mat-icon>add</mat-icon>
    Add Person
  </button>
</mat-toolbar>

<!-- Main Content -->
<div class="content-container">
  
  <!-- Filter Form -->
  <div class="filter-section" *ngIf="!selectedPersons.length">
    <div class="filter-row">
      <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput placeholder="Search by name, code..." [(ngModel)]="params.searchBy"
          name="searchBy" (keyup.enter)="search()">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Nationality</mat-label>
        <mat-select [(ngModel)]="params.nationality" name="nationality" (selectionChange)="search()">
          <mat-option value="">All</mat-option>
          <mat-option [value]="1">Dubai</mat-option>
          <mat-option [value]="2">Abu Dhabi</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-button-toggle-group [(ngModel)]="params.private" 
                              name="privateToggle" 
                              (change)="search()" 
                              [ngModelOptions]="{standalone: true}"
                              multiple>
        <mat-button-toggle [value]="false">Public</mat-button-toggle>
        <mat-button-toggle [value]="true">Private</mat-button-toggle>
      </mat-button-toggle-group>

      <mat-button-toggle-group [(ngModel)]="params.status" 
                              name="statusToggle" 
                              (change)="search()" 
                              [ngModelOptions]="{standalone: true}"
                              multiple>
        <mat-button-toggle [value]="0">New</mat-button-toggle>
        <mat-button-toggle [value]="1">Active</mat-button-toggle>
        <mat-button-toggle [value]="2">Inactive</mat-button-toggle>
      </mat-button-toggle-group>
    </div>

    <div class="action-row">
      <button mat-raised-button color="primary" (click)="exportToExcel()">
        <mat-icon>download</mat-icon>
        Export
      </button>
      
      <button mat-icon-button [matMenuTriggerFor]="columnMenu" matTooltip="Column Settings">
        <mat-icon>settings</mat-icon>
      </button>

      <mat-menu #columnMenu="matMenu">
        <div class="column-settings">
          <mat-slide-toggle [(ngModel)]="columns.code">Code</mat-slide-toggle>
          <mat-slide-toggle [(ngModel)]="columns.nameEn">Name En</mat-slide-toggle>
          <mat-slide-toggle [(ngModel)]="columns.nameAr">Name Ar</mat-slide-toggle>
          <mat-slide-toggle [(ngModel)]="columns.status">Status</mat-slide-toggle>
          <mat-slide-toggle [(ngModel)]="columns.private">Private</mat-slide-toggle>
        </div>
      </mat-menu>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions" *ngIf="selectedPersons.length">
    <div class="bulk-actions-header">
      <span class="selected-count">{{ selectedPersons.length }} Selected</span>
      <div class="bulk-actions-buttons">
        <button mat-button color="primary" *ngIf="currentMenu?.canUpdate" (click)="bulkChangeStatus(activeStatus)">
          <mat-icon>check_circle</mat-icon> 
          Activate
        </button>
        <button mat-button color="accent" *ngIf="currentMenu?.canUpdate" (click)="bulkChangeStatus(inactiveStatus)">
          <mat-icon>cancel</mat-icon> 
          Inactivate
        </button>
        <button mat-button color="primary"*ngIf="currentMenu?.canUpdate" (click)="bulkChangePrivate(false)">
          <mat-icon>visibility</mat-icon> 
          Mark Public
        </button>
        <button mat-button color="accent" *ngIf="currentMenu?.canUpdate" (click)="bulkChangePrivate(true)">
          <mat-icon>visibility_off</mat-icon> 
          Mark Private
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="showLoading" class="loading-container">
    <mat-spinner diameter="40" strokeWidth="4" color="accent"></mat-spinner>
  </div>

  <!-- Data Table -->
  <app-shared-table 
    *ngIf="!showLoading" 
    [displayedColumns]="displayColumns" 
    [paginateResult]="data"
    [action]="actionButtonsTemplate" 
    (onChangePage)="changePage($event)" 
    (rowClick)="onRowClick($event)"
    (onSortChangeEvent)="changeSort($event)" 
    (selectionChange)="onSelectionChange($event)">
  </app-shared-table>

  <!-- Row Menu Template -->
  <ng-template #actionButtonsTemplate let-row>
    <button mat-icon-button [matMenuTriggerFor]="menuRow">
      <mat-icon>more_horiz</mat-icon>
    </button>
    <mat-menu #menuRow="matMenu">
      <button mat-menu-item *ngIf="currentMenu?.canUpdate" (click)="activate(row)">
        <mat-icon>check_circle</mat-icon>
        <span>Activate</span>
      </button>
      <button mat-menu-item *ngIf="currentMenu?.canUpdate" (click)="deactivate(row)">
        <mat-icon>cancel</mat-icon>
        <span>Inactivate</span>
      </button>
      <button mat-menu-item *ngIf="currentMenu?.canUpdate" (click)="markPublic(row)">
        <mat-icon>visibility</mat-icon>
        <span>Mark Public</span>
      </button>
      <button mat-menu-item *ngIf="currentMenu?.canUpdate" (click)="markPrivate(row)">
        <mat-icon>visibility_off</mat-icon>
        <span>Mark Private</span>
      </button>
         <button mat-menu-item (click)="exportToPdf(row.id)">
        <mat-icon>print</mat-icon>
        <span>Print</span>
      </button>
      <button mat-menu-item *ngIf="currentMenu?.canDelete" (click)="deletePerson(row)">
        <mat-icon>delete</mat-icon>
        <span>Delete</span>
      </button>
    </mat-menu>
  </ng-template>

</div>