<div class="main-container">

  <!-- SECTION 1: Loading State -->
  @if (showLoading) {
  <div class="section loading-section">
    <div class="loading">
      <mat-spinner diameter="50" strokeWidth="4"></mat-spinner>
    </div>
  </div>
  }

  <!-- SECTION 2: Person Header -->
  @if (!showLoading) {
  <div class="section section-header">
    <!-- Breadcrumb -->
    <div class="breadcrumb-nav">
      <a (click)="navigateToPersons()" class="breadcrumb-link">
        <mat-icon>arrow_back</mat-icon>
        {{ label.PERSON.PERSONS }}
      </a>
      <span class="breadcrumb-separator">/</span>
      <span class="current-page">{{ person?.personEnglishName | titlecase }}</span>
    </div>

    <!-- Person Header Card -->
    <div class="person-header-card">
      <div class="person-profile-section">
        <!-- Profile Image -->
        <div class="person-image-container">
          <img *ngIf="imageUrl" [src]="imageUrl" [alt]="[label.PERSON.PERSON_ID_DOCUMENTS]" class="person-image" />
          <img *ngIf="!imageUrl" [src]="fallbackImage" [alt]="[label.PERSON.PERSON_ID_DOCUMENTS]"
            class="person-image" />

          <!-- Hidden file input -->
          <input type="file" accept="image/*" #fileInput style="display: none" (change)="onFileSelected($event)" />

          <button mat-icon-button class="upload-btn" (click)="openFilePicker(fileInput)"
            [title]="label.PERSON.UPLOAD_DOCUMENT">
            <mat-icon>photo_camera</mat-icon>
          </button>
        </div>

        <!-- Person Details -->
        <div class="person-details">
          <div class="person-name-section">
            <div class="name-and-badges">
              <h1 class="person-name">{{ person?.personEnglishName | titlecase }}</h1>
              <div class="person-status-badges">
                <span class="status-badge" [ngStyle]="getPersonStatusStyle()">
                  <mat-icon>{{ person?.personStatus === 1 ? 'check_circle' : 'cancel' }}</mat-icon>
                  {{ person?.personStatus | textPipe : 'person-status' | async}}
                </span>
                <span class="privacy-badge" [ngStyle]="getPersonPrivateStyle()">
                  <mat-icon>{{ person?.private ? 'lock' : 'public' }}</mat-icon>
                  {{ person?.private | textPipe : 'private-person' | async}}
                </span>
              </div>
            </div>
            <div class="person-name-arabic">{{ person?.personArabicName | titlecase }}</div>
          </div>

          <div class="person-meta-info">
            <div class="info-item">
              <span class="info-label">{{ label.PERSON.ID_NUMBER }}:</span>
              <span class="info-value">{{ person?.personCode }}</span>
            </div>
            <div class="info-item" *ngIf="person?.personShortName">
              <span class="info-label">{{ label.COMMON.SHORT_NAME }}:</span>
              <span class="info-value">{{ person?.personShortName | uppercase }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="person-actions">
        <button mat-raised-button color="primary" (click)="openPersonDialog()" class="action-btn">
          <mat-icon>edit</mat-icon>
          {{ label.PERSON.EDIT_PERSON }}
        </button>

        <button mat-button [matMenuTriggerFor]="moreMenu" class="more-actions-btn">
          <mat-icon>more_vert</mat-icon>
          {{ label.COMMON.MORE_ACTIONS }}
        </button>

        <mat-menu #moreMenu="matMenu">
          <button mat-menu-item (click)="exportToPdf()">
            <mat-icon>picture_as_pdf</mat-icon>
            {{ label.COMMON.PRINT }}
          </button>
        </mat-menu>
      </div>
    </div>
  </div>
  }

  <!-- SECTION 3: Content Tabs -->
  @if (!showLoading) {
  <div class="section section-content">
    <div class="tabs-container">
      <mat-tab-group class="modern-tabs" [selectedIndex]="selectedTab" (selectedIndexChange)="selectedTab = $event">
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>dashboard</mat-icon>
              <span>{{ label.COMMON.OVERVIEW || 'Overview' }}</span>
            </div>
          </ng-template>
          <div class="tab-content">
            <mat-accordion multi>
              <!-- Personal Information Group -->
              <mat-expansion-panel expanded="true" class="overview-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>person</mat-icon>
                    <span>{{ 'Personal Information' }}</span>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="panel-content">
                  <div class="contact-section">
                    @if (person) {
                    <app-person-overview-component [person]="person"></app-person-overview-component>
                    }
                  </div>
                  <div class="contact-section">
                    <app-shared-register-note-table [registersIdc]="personIdc" [registersIdn]="personId"
                      [canCrud]="false"></app-shared-register-note-table>
                  </div>
                </div>
              </mat-expansion-panel>

              <!-- Contact Information Group -->
              <mat-expansion-panel expanded="true" class="overview-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>contact_mail</mat-icon>
                    <span>{{ 'Contact Information' }}</span>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="panel-content">
                  <div class="contact-section">
                    @if(person) {
                    <app-person-email-component [readOnly]="true" [person]="person"></app-person-email-component>
                    }
                  </div>
                  <div class="contact-section">
                    @if(person) {
                    <app-person-phone-component [readOnly]="true" [person]="person"></app-person-phone-component>
                    }
                  </div>
                  <div class="contact-section">
                    @if(person) {
                    <app-person-address-component [readOnly]="true" [person]="person"></app-person-address-component>
                    }
                  </div>
                </div>
              </mat-expansion-panel>

              <!-- Business Relationships Group -->
              <mat-expansion-panel expanded="true" class="overview-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>business</mat-icon>
                    <span>{{ 'Business Relationships' }}</span>
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="panel-content">
                  <div class="contact-section">
                    @if (person) {
                    <app-person-in-charge-component [person]="person"></app-person-in-charge-component>
                    }
                  </div>
                  <div class="contact-section">
                    @if (person) {
                    <app-person-board-membership-component [person]="person"></app-person-board-membership-component>
                    }
                  </div>
                  <div class="contact-section">
                    @if (person) {
                    <app-person-account-signatory-component [person]="person"></app-person-account-signatory-component>
                    }
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>folder</mat-icon>
              <span>{{ label.PERSON.PERSON_ID_DOCUMENTS }}</span>
            </div>
          </ng-template>
          <div class="tab-content">
            <div class="contact-section">
              <app-person-id-documents-table-component></app-person-id-documents-table-component>
            </div>
            <div class="contact-section">
              <app-person-other-documents-table-component></app-person-other-documents-table-component>
            </div>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>contacts</mat-icon>
              <span>{{ label.COMMON.CONTACTS || 'Contacts' }}</span>
            </div>
          </ng-template>
          <div class="tab-content">
            <div class="row">
              <div class="contact-section col-6">
                @if(person) {
                <app-person-email-component [person]="person"></app-person-email-component>
                }
              </div>
              <div class="contact-section col-6">
                @if (person) {
                <app-person-phone-component [person]="person"></app-person-phone-component>
                }
              </div>
              <div class="contact-section">
                @if (person) {
                <app-person-address-component [person]="person"></app-person-address-component>
                }
              </div>
            </div>
          </div>
        </mat-tab>

        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>business_center</mat-icon>
              <span>{{ label.COMMON.ASSETS || 'Assets' }}</span>
            </div>
          </ng-template>
          <div class="tab-content">
            @if (person) {
            <div class="company-overview-component">
              <app-shared-company-shareholder-component [registersIdc]="personIdc"
                [registersIdn]="person!.id"></app-shared-company-shareholder-component>
            </div>

            <div class="company-overview-component">
              <app-shared-property-component [registersIdc]="personIdc"
                [registersIdn]="person!.id"></app-shared-property-component>
            </div>
            }
          </div>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>list_alt</mat-icon>
              <span>{{ label.TRANSACTION.TRANSACTION_REGISTERS }}</span>
            </div>
          </ng-template>
          <div class="tab-content">
            <div class="overview-component">
              <app-shared-transaction-register [idc]="personIdc!"
                [id]="person!.id"></app-shared-transaction-register>
            </div>
          </div>
        </mat-tab>
        <mat-tab>
          <ng-template mat-tab-label>
            <div class="tab-label">
              <mat-icon>notes</mat-icon>
              <span>{{ label.COMMON.NOTES || 'Notes' }}</span>
            </div>
          </ng-template>
          <div class="tab-content">
            <app-shared-register-note-table [registersIdc]="personIdc"
              [registersIdn]="personId"></app-shared-register-note-table>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
  }

</div>